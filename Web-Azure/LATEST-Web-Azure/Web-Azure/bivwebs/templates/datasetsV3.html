{% extends 'layout.html' %}
{% block content %}

<head>
    <style>
        .selected-dataset {
            background-color: #e6e6e6;
        }

        .selectable-user:hover,
        li:hover {
            cursor: pointer;
            background-color: #f5f5f5;
        }

        .upload-form-group {
            margin-bottom: 15px;
        }

        .required {
            color: red;
        }

        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
        }

        .progress-bar-fill {
            width: 0%;
            height: 30px;
            background-color: #76c7c0;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>

<div class="container-fluid">
    <div class="row" style="margin-top: 70px;">
        <div class="card shadow w-50">
            <div class="card-header">Dataset</div>
            <div class="card-body">
                <div class="row">
                    <!-- 左侧内容，固定宽度 -->
                    <div class="col-md-5">
                        <div class="mb-3">
                            <!-- <h5 class="card-title">Dataset List</h5> -->
                            <div id="datasetList" class="table table-striped table-hover"></div>
                        </div>
                        <div class="form-group">
                            <label for="filename">TifFile:<span class="required">*</span></label>
                            <input type="file" class="form-control-file" id="fileInputTiff">
                            <button type="button" class="btn btn-primary" id="submitBtn">Submit</button>
                        </div>
                        <div class="form-group">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="progress-bar-fill">0%</div>
                            </div>
                        </div>
                    </div>
                    <!-- 右侧内容，固定宽度 -->
                    <div class="col-md-7">
                        <!-- <h5 class="card-title">Dataset Info</h5> -->
                        <div id="datasetInfo">
                            <!-- The data will be dynamically populated by JavaScript -->
                        </div>
                        <div class="mt-3">
                            <button id="downloadDatasetBtn" class="btn btn-sm btn-primary btn-icon-only">
                                <i class="fas fa-download"></i>
                            </button>
                            <button id="deleteDatasetBtn" class="btn btn-sm btn-danger ml-2 btn-icon-only">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedDatasetName = ""
    window.addEventListener("DOMContentLoaded", renderDatasetList())
    function renderDatasetList() {
        getDatasets().then(datasets => {
            const datasetList = document.getElementById('datasetList');
            datasetList.innerHTML = ''; // clear existing content
            const ul = document.createElement('ul');
            ul.classList.add('list-group');
            datasets.forEach(dataset => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.dataset.name = dataset.name;
                li.textContent = dataset.name;
                ul.appendChild(li)
            });
            datasetList.appendChild(ul);
            ul.addEventListener('click', (event) => {
                const selectedLi = event.target.closest('li');
                if (selectedLi) {
                    selectedDatasetName = selectedLi.dataset.name;
                    console.log('Selected dataset:', selectedDatasetName);
                    // Remove the selected-dataset class from all other li elements
                    const allLiElements = document.querySelectorAll('#datasetList li');
                    allLiElements.forEach((li) => {
                        if (li !== selectedLi) {
                            li.classList.remove('selected-dataset');
                        }
                    });
                    // Add the selected-dataset class to the selected li element
                    selectedLi.classList.add('selected-dataset');
                    // Fetch data for the selected dataset
                    fetch('/getDatasetsData', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            'datasetName': selectedDatasetName,
                        }),
                    })
                        .then(response => response.json())
                        .then(data => {

                            updateDatasetList(data);
                        })
                        .catch((error) => {
                            console.error('Error:', error)
                        });
                }
            });

            if (datasets.length > 0) {
                const firstLi = ul.querySelector('li');
                firstLi.click();
            }
        });
    }

    document.getElementById("downloadDatasetBtn").addEventListener("click", function () {
        if (selectedDatasetName) {
            fetch('/downloadDataset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'datasetName': selectedDatasetName,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    // Check if we get the URL list
                    if (data.download_urls && Array.isArray(data.download_urls)) {
                        if (data.download_urls.length === 0) {
                            alert("No files found for the selected dataset.");
                            return;
                        }
                        data.download_urls.forEach(url => {
                            window.open(url, '_blank');
                        });
                    } else {
                        console.error("Received unexpected data format from server:", data);
                    }
                })
                .catch(error => console.error('Error:', error));
        } else {
            alert("Please select a dataset first!");
        }
    });

    // Listen to the delete button 
    document.getElementById("deleteDatasetBtn").addEventListener("click", function () {
        if (selectedDatasetName) {
            const isConfirmed = confirm("Are you sure you want to delete this dataset? This action cannot be undone.");
            if (isConfirmed) {
                fetch('/deleteDataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'datasetName': selectedDatasetName,
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            renderDatasetList();
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        } else {
            alert("Please select a dataset first!");
        }
    });

    function updateDatasetList(datasets) {
        const dataset = datasets[0]
        console.log(dataset)
        const datasetInfoDiv = document.getElementById('datasetInfo');
        datasetInfoDiv.innerHTML = ''; // 清空现有内容

        const form = document.createElement('form');
        form.className = 'dataset-info-form';
        let formHTML = `
        <h6>Name: <input type="text" class="form-control mb-2" name="name" value="${dataset.name}" /></h6>
        <div><strong>Types:</strong></div>`;

        if (dataset.types) {
            let typesContent = '<h6>Types:</h6><ul>';
            Object.keys(dataset.types).forEach((type) => {
                typesContent += `<li>${type}:`;
                Object.keys(dataset.types[type]).forEach((exposure) => {
                    const wavelengths = dataset.types[type][exposure];
                    typesContent += ` Exposure ${exposure} - Wavelengths: ${wavelengths.join(', ')}`;
                });
                typesContent += '</li>';
            });
            typesContent += '</ul>';
            datasetInfoDiv.innerHTML = typesContent;
        } else {
            datasetInfoDiv.innerHTML = '<p>No types information available.</p>';
        }

        formHTML += `
        <h6>Voxels:</h6>
        <div class="mb-2">X: <input type="number" class="form-control" name="voxels[x]" value="${dataset.voxels.x}" /></div>
        <div class="mb-2">Y: <input type="number" class="form-control" name="voxels[y]" value="${dataset.voxels.y}" /></div>
        <div class="mb-2">Z: <input type="number" class="form-control" name="voxels[z]" value="${dataset.voxels.z}" /></div>

        <h6>Dims3:</h6>
        <div class="mb-2">X: <input type="number" class="form-control" name="dims3[x]" value="${dataset.dims3.x}" /></div>
        <div class="mb-2">Y: <input type="number" class="form-control" name="dims3[y]" value="${dataset.dims3.y}" /></div>
        <div class="mb-2">Z: <input type="number" class="form-control" name="dims3[z]" value="${dataset.dims3.z}" /></div>

        <h6>Pixel Length UM: <input type="text" class="form-control mb-2" name="pixelLengthUM" value="${dataset.pixelLengthUM}" /></h6>

        <h6>Dims2:</h6>
        <div class="mb-2">X: <input type="text" class="form-control" name="dims2[x]" value="${dataset.dims2.x}" /></div>
        <div class="mb-2">Y: <input type="text" class="form-control" name="dims2[y]" value="${dataset.dims2.y}" /></div>
        <div class="mb-2">Z: <input type="text" class="form-control" name="dims2[z]" value="${dataset.dims2.z}" /></div>

        <h6>Image Dims:</h6>
        <div class="mb-2">X: <input type="text" class="form-control" name="imageDims[x]" value="${dataset.imageDims.x}" /></div>
        <div class="mb-2">Y: <input type="text" class="form-control" name="imageDims[y]" value="${dataset.imageDims.y}" /></div>
        <div class="mb-2">Z: <input type="text" class="form-control" name="imageDims[z]" value="${dataset.imageDims.z}" /></div>

        <h6>Z Skip: <input type="number" class="form-control mb-2" name="zskip" value="${dataset.zskip}" /></h6>

        <h6>Info:</h6>
        <div class="mb-2">Specimen: <input type="text" class="form-control" name="info[specimen]" value="${dataset.info.specimen}" /></div>
        <div class="mb-2">PI: <input type="text" class="form-control" name="info[PI]" value="${dataset.info.PI}" /></div>
        <div class="mb-2">Voxels: <input type="text" class="form-control" name="info[voxels]" value="${dataset.info.voxels}" /></div>
        <div class="mb-2">Thickness: <input type="text" class="form-control" name="info[thickness]" value="${dataset.info.thickness}" /></div>

    
        <button type="submit" class="btn btn-primary mt-2">Update</button>
    `;

        form.innerHTML = formHTML;
        datasetInfoDiv.appendChild(form);

        // 添加表单提交事件监听
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const updateData = Object.fromEntries(formData.entries());
            // 注意：这里可能需要进一步处理updateData以符合后端接口的期望格式

            // 替换为实际的更新数据API
            fetch('/updateDataset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'datasetId': dataset._id, // 如果需要
                    'updateData': updateData,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Dataset updated successfully!');
                    } else {
                        alert('Failed to update dataset.');
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    }



    function getDatasets() {
        return fetch('getDatasets')
            .then(response => response.json())
            .then(datasets => {
                return datasets;
            })
            .catch(error => {
                console.error('Error:', error);
                return [];
            });
    }
</script>

{% endblock content %}