{% extends 'layout.html' %}
{% block content %}

<head>
    <style>
        .selected-dataset {
            background-color: #e6e6e6;
        }

        .selectable-user:hover,
        li:hover {
            cursor: pointer;
            background-color: #f5f5f5;
        }

        .upload-form-group {
            margin-bottom: 15px;
        }

        .required {
            color: red;
        }

        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
        }

        .progress-bar-fill {
            width: 0%;
            height: 30px;
            background-color: #76c7c0;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>
<div class="container-fluid">
    <div class="row" style="margin-top: 70px;">
        <div class="col-6">
            <div class="card shadow">
                <div class="card-header">Upload Dataset</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-3">
                            <div class="upload-form-group">
                                <label for="dataset-name">Dataset Name:<span class="required">*</span></label>
                                <input type="text" id="dataset-name" name="dataset-name" class="form-control" required>
                            </div>
                            <div class="upload-form-group">
                                <label for="type">Modality:<span class="required">*</span></label>
                                <select id="modality" name="type" class="form-control" required>
                                    <option value="Brightfield">Brightfield</option>
                                    <option value="Fluorescent">Fluorescent</option>
                                </select>
                            </div>
                            <div class="upload-form-group">
                                <label for="type">Exposure:<span class="required">*</span></label>
                                <select id="exposure" name="type" class="form-control" required>
                                    <option value="1">1</option>
                                    <option value="0">0</option>
                                </select>
                            </div>

                            <div class="upload-form-group">
                                <label for="type">Wavelength:<span class="required">*</span></label>
                                <select id="wavelength" name="type" class="form-control" required>
                                    <option value="430">430nm</option>
                                    <option value="650">650nm</option>
                                </select>
                            </div>
                            <div class="upload-form-group">
                                <label for="pixelLengthUM">pixelLengthUM:<span class="required">*</span></label>
                                <input type="text" id="pixelLengthUM" name="pixelLengthUM" class="form-control"
                                    required>
                            </div>
                            <div class="upload-form-group">
                                <label for="zskip">zskip:<span class="required">*</span></label>
                                <input type="text" id="zskip" name="zskip" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="upload-form-group">
                                <label for="voxels">voxels:<span class="required">*</span></label>
                                <input type="text" id="voxels-x" name="voxels-x" placeholder="x" class="form-control"
                                    required>
                                <input type="text" id="voxels-y" name="voxels-y" placeholder="y" class="form-control"
                                    required>
                                <input type="text" id="voxels-z" name="voxels-z" placeholder="z" class="form-control"
                                    required>
                            </div>
                            <div class="upload-form-group">
                                <label for="Dims2">Dims2:<span class="required">*</span></label>
                                <input type="text" id="Dims2-x" name="Dims2-x" placeholder="x" class="form-control"
                                    required>
                                <input type="text" id="Dims2-y" name="Dims2-y" placeholder="y" class="form-control"
                                    required>
                                <input type="text" id="Dims2-z" name="Dims2-z" placeholder="z" class="form-control"
                                    required>
                            </div>
                            <div class="upload-form-group">
                                <label for="Dims3">Dims3:<span class="required">*</span></label>
                                <input type="text" id="Dims3-x" name="Dims3-x" placeholder="x" class="form-control"
                                    required>
                                <input type="text" id="Dims3-y" name="Dims3-y" placeholder="y" class="form-control"
                                    required>
                                <input type="text" id="Dims3-z" name="Dims3-z" placeholder="z" class="form-control"
                                    required>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="upload-form-group">
                                <label for="specimen-name">Specimen Name:</label>
                                <input type="text" id="specimen-name" name="dataset-name" class="form-control">
                            </div>
                            <div class="upload-form-group">
                                <label for="PI">PI:</label>
                                <input type="text" id="PI" name="PI" class="form-control">
                            </div>
                            <div class="upload-form-group">
                                <label for="voxel_size">Voxel Size:</label>
                                <input type="text" id="voxel_size" name="voxel_size" class="form-control">
                            </div>
                            <div class="upload-form-group">
                                <label for="thickness">thickness:</label>
                                <input type="text" id="thickness" name="thickness" class="form-control">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group">
                                <label for="filename">TifFile:<span class="required">*</span></label>
                                <input type="file" class="form-control-file" id="fileInputTiff">
                            </div>
                            <button type="button" class="btn btn-primary" id="submitBtn">Submit</button>
                            <div class="form-group">
                                <div class="progress-bar">
                                    <div class="progress-bar-fill" id="progress-bar-fill">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card shadow">
                <div class="card-header">Dataset Info</div>
                <div class="card-body">
                    <div class="row">
                        <div class="card border-0">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-7">
                                        <div class="upload-form-group">
                                            <h5 class="card-title">Dataset List</h5>
                                            <div id="datasetList" class="table table-striped table-hover"></div>
                                        </div>
                                    </div>
                                    <div class="col-5">
                                        <div class="upload-form-group">
                                            <h5 class="card-title">Dataset Info</h5>
                                            <div id="datasetInfo">
                                                <!-- 数据将由JavaScript动态填充 -->
                                            </div>
                                            <div class="mt-3">
                                                <button id="downloadDatasetBtn"
                                                    class="btn btn-sm btn-primary btn-icon-only">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button id="deleteDatasetBtn"
                                                    class="btn btn-sm btn-danger ml-2 btn-icon-only">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/3.0.3/socket.io.min.js"></script>
    <script>
        let selectedDatasetName = ""
        document.getElementById('downloadDatasetBtn').disabled = true
        document.getElementById('deleteDatasetBtn').disabled = true
        window.addEventListener("DOMContentLoaded", renderDatasetList())
        function renderDatasetList() {
            getDatasets().then(datasets => {
                const datasetList = document.getElementById('datasetList');
                datasetList.innerHTML = ''; // clear existing content
                const ul = document.createElement('ul');
                ul.classList.add('list-group');
                datasets.forEach(dataset => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.dataset.name = dataset.name;
                    li.textContent = dataset.name;
                    ul.appendChild(li)
                });
                datasetList.appendChild(ul);
                ul.addEventListener('click', (event) => {
                    const selectedLi = event.target.closest('li');
                    if (selectedLi) {
                        selectedDatasetName = selectedLi.dataset.name;
                        console.log('Selected dataset:', selectedDatasetName);
                        // Remove the selected-dataset class from all other li elements
                        const allLiElements = document.querySelectorAll('#datasetList li');
                        allLiElements.forEach((li) => {
                            if (li !== selectedLi) {
                                li.classList.remove('selected-dataset');
                            }
                        });
                        // Add the selected-dataset class to the selected li element
                        selectedLi.classList.add('selected-dataset');
                        // Fetch data for the selected dataset
                        fetch('/getDatasetsData', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                'datasetName': selectedDatasetName,
                            }),
                        })
                            .then(response => response.json())
                            .then(data => {
                                // 为了简化，这里我们只显示一个JSON字符串，但你可以根据需要更优雅地显示数据
                                updateDatasetList(data);
                            })
                            .catch((error) => {
                                console.error('Error:', error)
                            });
                    }
                });
                // 若数据集列表非空，则模拟点击第一个数据集
                if (datasets.length > 0) {
                    const firstLi = ul.querySelector('li');
                    firstLi.click();
                }
            });
        }

        document.getElementById("downloadDatasetBtn").addEventListener("click", function () {
            if (selectedDatasetName) {
                fetch('/downloadDataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'datasetName': selectedDatasetName,
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        // 使用获得的URL自动触发下载
                        window.location.href = data.download_url;
                    })
                    .catch(error => console.error('Error:', error));
            } else {
                alert("Please select a dataset first!");
            }
        });

        // 监听删除按钮的点击事件
        document.getElementById("deleteDatasetBtn").addEventListener("click", function () {
            if (selectedDatasetName) {  // 确保有选择的数据集
                const isConfirmed = confirm("Are you sure you want to delete this dataset? This action cannot be undone.");
                if (isConfirmed) {
                    fetch('/deleteDataset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            'datasetName': selectedDatasetName,
                        }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 更新数据集列表或其他所需操作
                                renderDatasetList();
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                }
            } else {
                alert("Please select a dataset first!");
            }
        });





        function updateDatasetList(data) {
            const datasetInfoDiv = document.getElementById('datasetInfo');

            // 清除现有内容
            datasetInfoDiv.innerHTML = '';

            data.forEach(dataset => {
                const datasetDiv = document.createElement('div');

                datasetDiv.innerHTML = `
            <h6>Name: ${dataset.name}</h6>
            <div><strong>Types:</strong> ${JSON.stringify(dataset.types)}</div>
            <div><strong>Voxels:</strong> ${JSON.stringify(dataset.voxels)}</div>
            <div><strong>Dims2:</strong> ${JSON.stringify(dataset.dims2)}</div>
            <div><strong>Dims3:</strong> ${JSON.stringify(dataset.dims3)}</div>
            <div><strong>Pixel Length:</strong> ${dataset.pixelLengthUM}</div>
            <div><strong>Image Dims:</strong> ${JSON.stringify(dataset.imageDims)}</div>
            <div><strong>Zskip:</strong> ${dataset.zskip}</div>
            <div><strong>Info:</strong> ${JSON.stringify(dataset.info)}</div>
        `;

                datasetInfoDiv.appendChild(datasetDiv);
            });
        }

        document.getElementById('submitBtn').addEventListener('click', async function () {
            const datasetNameInput = document.getElementById('dataset-name');
            const modality = document.getElementById('modality');
            const exposure = document.getElementById('exposure');
            const wavelength = document.getElementById('wavelength');
            const voxels_x = document.getElementById('voxels-x');
            const voxels_y = document.getElementById('voxels-y');
            const voxels_z = document.getElementById('voxels-z');
            const Dims2_x = document.getElementById('Dims2-x');
            const Dims2_y = document.getElementById('Dims2-y');
            const Dims2_z = document.getElementById('Dims2-z');
            const Dims3_x = document.getElementById('Dims3-x');
            const Dims3_y = document.getElementById('Dims3-y');
            const Dims3_z = document.getElementById('Dims3-z');
            const pixelLengthUM = document.getElementById('pixelLengthUM');
            const zskip = document.getElementById('zskip')
            const specimenName = document.getElementById('specimen-name');
            const PI = document.getElementById('PI');
            const voxel_size = document.getElementById('voxel_size');
            const thickness = document.getElementById('thickness');
            const fileInputTiff = document.getElementById('fileInputTiff');
            const fileTiff = fileInputTiff.files[0];
            // Create an array containing all input boxes that need to be checked
            const requiredInputs = [datasetNameInput, voxels_x, voxels_y, voxels_z, Dims3_x, Dims3_y, Dims3_z, pixelLengthUM, zskip];

            // Iterate over each input box, if any of them are empty, stop the upload and show a warning
            for (let input of requiredInputs) {
                if (input.value.trim() === '') {
                    alert('Please fill out all required fields.');
                    return;
                }
            }
            const formData = new FormData();
            formData.append('dataset-name', datasetNameInput.value);
            formData.append('modality', modality.value);
            formData.append('exposure', exposure.value);
            formData.append('wavelength', wavelength.value);
            formData.append('voxels_x', voxels_x.value);
            formData.append('voxels_y', voxels_y.value);
            formData.append('voxels_z', voxels_z.value);
            formData.append('Dims2_x', Dims2_x.value);
            formData.append('Dims2_y', Dims2_y.value);
            formData.append('Dims2_z', Dims2_z.value);
            formData.append('Dims3_x', Dims3_x.value);
            formData.append('Dims3_y', Dims3_y.value);
            formData.append('Dims3_z', Dims3_z.value);
            formData.append('pixelLengthUM', pixelLengthUM.value);
            formData.append('zskip', zskip.value);
            formData.append('spcimenName', specimenName.value);
            formData.append('PI', PI.value);
            formData.append('voxel_size', voxel_size.value);
            formData.append('thickness', thickness.value);
            formData.append('FileName', fileTiff.name);
            formData.append('fileContent', fileTiff); // Add the file content here

            var fileExtension = fileInputTiff.files[0].name.split('.').pop().toLowerCase(); // Get file extension name
            if (fileExtension !== 'tif') {
                alert('Wrong file format! Please upload the .tif file');
                return;
            }

            // Start getProgress function
            shouldContinue = true;
            getProgress();

            const response = await fetch('/UploadDataset', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                console.error('Upload failed:', response.statusText);
            } else {
                shouldContinue = false
                const data = await response.json();
                alert(data.message)
                submitBtn.disabled = false;
            }
        });

        function getDatasets() {
            return fetch('getDatasets')
                .then(response => response.json())
                .then(datasets => {
                    return datasets;
                })
                .catch(error => {
                    console.error('Error:', error);
                    return [];
                });
        }

        function getProgress() {
            if (!shouldContinue) {
                console.log("Exiting getProgress because shouldContinue is false");
                return;
            }

            fetch('/progress')
                .then(response => {
                    if (!response.ok) {
                        console.error('Response not OK:', response);
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    const progress = data.progress;
                    const progress_per = progress * 100;
                    console.log(progress, progress_per);
                    document.getElementById('progress-bar-fill').style.width = progress_per + '%';
                    document.getElementById('progress-bar-fill').textContent = Math.round(progress_per) + '%';

                    // If shouldContinue still true，invoke getProgress
                    if (shouldContinue) {
                        setTimeout(getProgress, 1000); // set 1 second delay time 
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        }
    </script>
    {% endblock %}