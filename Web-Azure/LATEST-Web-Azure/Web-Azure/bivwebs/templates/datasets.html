{% extends 'layout.html' %}
{% block content %}

<head>
    <style>
        /* 省略你已经有的CSS代码... */

        /* 添加一个新的样式用于控制上传表单的布局 */
        .upload-form-group {
            margin-bottom: 15px;
        }

        .required {
            color: red;
        }

        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
        }

        .progress-bar-fill {
            width: 0%;
            height: 30px;
            background-color: #76c7c0;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>
<div class="container-fluid">
    <div class="row" style="margin-top: 70px;">
        <div class="col-6">
            <div class="card shadow">
                <div class="card-header">Upload Dataset</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-2">
                            <div class="upload-form-group">
                                <label for="dataset-name">Dataset Name:<span class="required">*</span></label>
                                <input type="text" id="dataset-name" name="dataset-name" class="form-control" required>
                            </div>
                            <div class="upload-form-group">
                                <label for="type">Modality:<span class="required">*</span></label>
                                <select id="modality" name="type" class="form-control" required>
                                    <option value="Brightfield">Brightfield</option>
                                    <option value="fluorescent">Fluorescent</option>
                                </select>
                            </div>

                            <div class="upload-form-group">
                                <label for="type">Exposure:<span class="required">*</span></label>
                                <select id="exposure" name="type" class="form-control" required>
                                    <option value="1">1</option>
                                    <option value="0">0</option>
                                </select>
                            </div>

                            <div class="upload-form-group">
                                <label for="type">Wavelength:<span class="required">*</span></label>
                                <select id="wavelength" name="type" class="form-control" required>
                                    <option value="430">430nm</option>
                                    <option value="650">650nm</option>
                                </select>
                            </div>
                            <div class="upload-form-group">
                                <label for="axis">Axis:<span class="required">*</span></label><br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="axis" id="xy" value="xy">
                                    <label class="form-check-label" for="xy">xy</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="axis" id="xz" value="xz">
                                    <label class="form-check-label" for="xz">xz</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="axis" id="yz" value="yz">
                                    <label class="form-check-label" for="yz">yz</label>
                                </div>
                            </div>
                            <div class="upload-form-group">
                                <label for="pixelLengthUM">pixelLengthUM:<span class="required">*</span></label>
                                <input type="text" id="pixelLengthUM" name="pixelLengthUM" class="form-control"
                                    required>
                            </div>
                            <div class="upload-form-group">
                                <label for="zskip">zskip:<span class="required">*</span></label>
                                <input type="text" id="zskip" name="zskip" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="upload-form-group">
                                <label for="voxels">voxels:<span class="required">*</span></label>
                                <input type="text" id="voxels-x" name="voxels-x" placeholder="x" class="form-control"
                                    required>
                                <input type="text" id="voxels-y" name="voxels-y" placeholder="y" class="form-control"
                                    required>
                                <input type="text" id="voxels-z" name="voxels-z" placeholder="z" class="form-control"
                                    required>
                            </div>
                            <div class="upload-form-group">
                                <label for="ImageDims">ImageDims:<span class="required">*</span></label>
                                <input type="text" id="ImageDims-x" name="ImageDims-x" placeholder="x"
                                    class="form-control" required>
                                <input type="text" id="ImageDims-y" name="ImageDims-y" placeholder="y"
                                    class="form-control" required>
                                <input type="text" id="ImageDims-z" name="ImageDims-z" placeholder="z"
                                    class="form-control" required>
                            </div>
                            <div class="upload-form-group">
                                <label for="Dims2">Dims2:<span class="required">*</span></label>
                                <input type="text" id="Dims2-x" name="Dims2-x" placeholder="x" class="form-control"
                                    required>
                                <input type="text" id="Dims2-y" name="Dims2-y" placeholder="y" class="form-control"
                                    required>
                                <input type="text" id="Dims2-z" name="Dims2-z" placeholder="z" class="form-control"
                                    required>
                            </div>
                            <div class="upload-form-group">
                                <label for="Dims3">Dims3:<span class="required">*</span></label>
                                <input type="text" id="Dims3-x" name="Dims3-x" placeholder="x" class="form-control"
                                    required>
                                <input type="text" id="Dims3-y" name="Dims3-y" placeholder="y" class="form-control"
                                    required>
                                <input type="text" id="Dims3-z" name="Dims3-z" placeholder="z" class="form-control"
                                    required>
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="upload-form-group">
                                <label for="specimen-name">Specimen Name:</label>
                                <input type="text" id="specimen-name" name="dataset-name" class="form-control">
                            </div>
                            <div class="upload-form-group">
                                <label for="PI">PI:</label>
                                <input type="text" id="PI" name="PI" class="form-control">
                            </div>
                            <div class="upload-form-group">
                                <label for="voxel_size">Voxel Size:</label>
                                <input type="text" id="voxel_size" name="voxel_size" class="form-control">
                            </div>
                            <div class="upload-form-group">
                                <label for="thickness">thickness:</label>
                                <input type="text" id="thickness" name="thickness" class="form-control">
                            </div>
                        </div>
                        <div class="col-2">
                            <div class="upload-form-group">
                                <label for="file">Upload:</label>
                                <input type="file" id="file" name="file" class="form-control-file" multiple required
                                    onchange="updateFileList()">
                            </div>
                            <div class="upload-form-group">
                                <button id="upload-button" class="btn btn-primary"
                                    onclick="uploadDataset()">Upload</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card shadow">
                <div class="card-header">3D Convert</div>
                <div class="card-body">
                    <div class="card border-0">
                        <div class="card-body">
                            <div class="row">
                                <form id="job-form">
                                    <div class="form-group">
                                        <label for="type">Modality:<span class="required">*</span></label>
                                        <select id="modality_3D" name="type" class="form-control" required>
                                            <option value="Brightfield">Brightfield</option>
                                            <option value="fluorescent">Fluorescent</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="type">Exposure:<span class="required">*</span></label>
                                        <select id="exposure_3D" name="type" class="form-control" required>
                                            <option value="1">1</option>
                                            <option value="0">0</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="type">Wavelength:<span class="required">*</span></label>
                                        <select id="wavelength_3D" name="type" class="form-control" required>
                                            <option value="430">430nm</option>
                                            <option value="650">650nm</option>
                                        </select>
                                    </div>
                                    <!-- <div class="form-group">
                                    <label for="path">InputPath:(e.g.C:\Users\Desktop\new test case 1\)<span
                                            class="required">*</span></label>
                                    <input type="text" class="form-control" id="path_3D" placeholder="Enter path">
                                </div> -->
                                    <div class="form-group">
                                        <label for="filename">TifFile:<span class="required">*</span></label>
                                        <input type="file" class="form-control-file" id="fileInputTiff">
                                    </div>
                                    <button type="button" class="btn btn-primary" id="submitBtn">Submit</button>
                                    <div class="form-group">
                                        <div class="progress-bar">
                                            <div class="progress-bar-fill" id="progress-bar-fill">0%</div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="popup"
        style="display: none; position: fixed; width: 100%; height: 100%; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 2; cursor: pointer;">
        <div
            style="position: absolute; top: 50%; left: 50%; font-size: 50px; color: white; transform: translate(-50%,-50%);-ms-transform: translate(-50%,-50%);">
            Processing, please wait...
        </div>
    </div>
    <script src="https://cdn.socket.io/3.0.3/socket.io.min.js"></script>
    <script>
        async function uploadDataset() {
            const datasetNameInput = document.getElementById('dataset-name');
            const modality = document.getElementById('modality');
            const exposure = document.getElementById('exposure');
            const wavelength = document.getElementById('wavelength');
            const axisInput = document.querySelector('input[name="axis"]:checked');
            const voxels_x = document.getElementById('voxels-x');
            const voxels_y = document.getElementById('voxels-y');
            const voxels_z = document.getElementById('voxels-z');
            const ImageDims_x = document.getElementById('ImageDims-x');
            const ImageDims_y = document.getElementById('ImageDims-y');
            const ImageDims_z = document.getElementById('ImageDims-z');
            const Dims2_x = document.getElementById('Dims2-x');
            const Dims2_y = document.getElementById('Dims2-y');
            const Dims2_z = document.getElementById('Dims2-z');
            const Dims3_x = document.getElementById('Dims3-x');
            const Dims3_y = document.getElementById('Dims3-y');
            const Dims3_z = document.getElementById('Dims3-z');
            const pixelLengthUM = document.getElementById('pixelLengthUM');
            const zskip = document.getElementById('zskip')

            const specimenName = document.getElementById('specimen-name');
            const PI = document.getElementById('PI');
            const voxel_size = document.getElementById('voxel_size');
            const thickness = document.getElementById('thickness');
            const fileInput = document.getElementById('file');



            // Create an array containing all input boxes that need to be checked
            const requiredInputs = [datasetNameInput, axisInput, voxels_x, voxels_y, voxels_z, ImageDims_x, ImageDims_y, ImageDims_z, Dims3_x, Dims3_y, Dims3_z, pixelLengthUM, zskip];

            // Iterate over each input box, if any of them are empty, stop the upload and show a warning
            for (let input of requiredInputs) {
                if (input.value.trim() === '') {
                    alert('Please fill out all required fields.');
                    return;  // 退出函数，停止上传
                }
            }

            const formData = new FormData();
            formData.append('dataset-name', datasetNameInput.value);
            formData.append('modality', modality.value);
            formData.append('exposure', exposure.value);
            formData.append('wavelength', wavelength.value);
            formData.append('axis', axisInput.value);
            formData.append('voxels_x', voxels_x.value);
            formData.append('voxels_y', voxels_y.value);
            formData.append('voxels_z', voxels_z.value);
            formData.append('ImageDims_x', ImageDims_x.value);
            formData.append('ImageDims_y', ImageDims_y.value);
            formData.append('ImageDims_z', ImageDims_z.value);
            formData.append('Dims2_x', Dims2_x.value);
            formData.append('Dims2_y', Dims2_y.value);
            formData.append('Dims2_z', Dims2_z.value);
            formData.append('Dims3_x', Dims3_x.value);
            formData.append('Dims3_y', Dims3_y.value);
            formData.append('Dims3_z', Dims3_z.value);
            formData.append('pixelLengthUM', pixelLengthUM.value);
            formData.append('zskip', zskip.value);
            formData.append('spcimenName', specimenName.value);
            formData.append('PI', PI.value);
            formData.append('voxel_size', voxel_size.value);
            formData.append('thickness', thickness.value);


            // 遍历所有文件并添加到formData
            for (const file of fileInput.files) {
                formData.append('files', file);
            }

            const response = await fetch('/dataset_upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                // 如果响应失败，打印错误信息
                console.error('Upload failed:', response.statusText);
            } else {
                const data = await response.json();
                // 打印成功信息和上传的数据集详情
                console.log(data.message, data);
                document.getElementById('file-names').innerText = data.files.join('\n');
            }
        }

        function getDatasets() {
            return fetch('getDatasets')
                .then(response => response.json())
                .then(datasets => {
                    return datasets;
                })
                .catch(error => {
                    console.error('Error:', error);
                    return [];
                });
        }

        let shouldContinue = true;
        document.getElementById('submitBtn').addEventListener('click', function () {
            // 设置一个定时器来定期获取进度更新
            const Modality = document.getElementById('modality_3D');
            const exposure = document.getElementById('exposure_3D');
            const wavelength_3D = document.getElementById('wavelength_3D');
            // const path = document.getElementById('path_3D');
            const fileInputTiff = document.getElementById('fileInputTiff');
            const fileTiff = fileInputTiff.files[0];

            // Create an array containing all input boxes that need to be checked
            const requiredInputs = [Modality, exposure, wavelength_3D, fileInputTiff];

            // Iterate over each input box, if any of them are empty, stop the upload and show a warning
            for (let input of requiredInputs) {
                if (input.value.trim() === '') {
                    alert('Please fill out all required fields.');
                    return;
                }
            }

            var fileExtension = fileInputTiff.files[0].name.split('.').pop().toLowerCase(); // 获取文件扩展名
            if (fileExtension !== 'tif') {
                alert('Wrong file format! Please upload the .tif file');
                return;
            }

            // Send the file content to backend
            var formData = new FormData();
            formData.append('Modality', Modality.value);
            formData.append('exposure', exposure.value);
            formData.append('wavelength', wavelength_3D.value);
            formData.append('FileName', fileTiff.name);
            formData.append('fileContent', fileTiff); // Add the file content here
            // 遍历FormData对象并在控制台输出内容
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }

            // 启动getProgress函数
            shouldContinue = true;
            getProgress();

            fetch('/driver', {
                method: 'POST',
                body: formData
            })
                .then(response => response.blob())
                .then(blob => {
                    shouldContinue = false
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'processed_images.zip';  // 设定下载文件的名称
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch((error) => console.error('Error:', error));
        });

        async function getProgress() {
            try {
                if (!shouldContinue) {
                    return;
                }

                console.log("getProgress");
                const response = await fetch('/progress');
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }

                const data = await response.json();
                const progress = data.progress; // Now correctly obtaining progress from the resolved promise
                const progress_per = progress * 100;
                console.log(progress, progress_per);
                document.getElementById('progress-bar-fill').style.width = progress_per + '%';
                document.getElementById('progress-bar-fill').textContent = Math.round(progress_per) + '%';

                // 如果shouldContinue仍然为true，则在一段时间后再次调用getProgress
                if (shouldContinue) {
                    setTimeout(getProgress, 1000); // 这里设置一个1秒的延时，你可以根据需要调整这个值
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }



    </script>
    {% endblock %}